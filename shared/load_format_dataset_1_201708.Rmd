---
title: "Load-Format dataset 1"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 
#libraries
```{r}
require("RPostgreSQL")
require("caret")
require("dplyr")
require("pROC")
```

#connect database
```{r}
drv <- dbDriver("PostgreSQL")
# creates a connection to the postgres database
# note that "con" will be used later in each connection to the database
con <- dbConnect(drv, dbname = "mimicsel",
                 host = "192.168.1.106", port = 5432,
                 user = "mimicsel", password = "mimicsel")


# check for the cartable
dbExistsTable(con, "ds_icu_stays_1")
# TRUE
```

#datatable from table


```{r}
ds_icu_2m<-dbGetQuery(con,"select 
PAT_GENDER,PAT_EXPIRE_HOSP,ADT_HOS_AGE,ADT_HSTAYS,ADT_READMIT,ICU_DBSOURCE,ICU_LOS,ICU_TYPE_FSERVICE,ICU_DEAD_BEFORE_28,ICU_HAS_PRESC_INSULIN,
ICU_HAS_ADMIV_INSULIN,ICU_HAS_ADMIT_INSULIN,ICU_STAY_MORE72,ICD9P_M,ICD9D_M,ICD9D_M_CHAPTER,DIAG_M_HAS_DIABET,DIAG_S_HAS_DIABET,COM_CONGEST_HEA_FAILURE ,COM_CARDIAC_ARRHYTHMIAS ,
COM_VALVULA_DISEASE ,COM_PULMONA_CIR_DISORDERS ,COM_PERIPHE_VAS_DISORDERS ,COM_HYPERTENSION ,COM_PARALYSIS ,COM_OTHER_NEUR_DISORDERS ,COM_CHRONIC_PUL_DISEASE ,
COM_DIABETES_UNCOMPLICATED ,COM_DIABETES_COMPLICATED ,COM_HYPOTHYROIDISM ,COM_RENAL_FAILURE ,COM_LIVER_DISEASE ,COM_PEPTIC_ULC_DISEASE ,COM_AIDS ,
COM_LYMPHOMA ,COM_METASTATIC_CANCER ,COM_SOLID_TUM_WO_METASTASIS ,COM_RHEUMATOID_ART_DISEASES ,COM_COAGULOPATHY ,COM_OBESITY ,COM_WEIGHT_LOSS ,COM_FLUID_ELEC_DISORDERS ,
COM_BLOOD_LOS_ANEMIA ,COM_DEFICIENCY_ANEMIAS ,COM_ALCOHOL_ABUSE ,COM_DRUG_ABUSE ,COM_PSYCHOSES ,COM_DEPRESSION ,SCORE_APSIII,SCORE_LODS,
SCORE_MLODS,SCORE_OASIS,SCORE_QSOFA,SCORE_SAPS,SCORE_SAPSII,SCORE_SOFA,SCORE_SIRS,MED_HAS_ALLERGIE_INSULIN,MED_HAS_INFECTION,MED_HAS_EXPLICIT_SEPSIS,
MED_HAS_ORGAN_DYSFUNCTION,MED_HAS_SEPSIS,MED_HAS_VASO,MED_HAS_24H_VASO,MED_HAS_DIALYSIS,MED_HAS_24H_DIALYSIS,MED_HAS_MECHVENT,MED_HAS_24H_MECHVENT,
MED_HAS_ESTEROID_PRESC,PH_AVG_24H,PH_STD_24H,PO2_AVG_24H,PO2_STD_24H,WHITEBLOOD_AVG_24H,WHITEBLOOD_STD_24H,LACTATE_AVG_24H,LACTATE_STD_24H,
HEMOGLOBIN_AVG_24H,HEMOGLOBIN_STD_24H,PCO2_AVG_24H,PCO2_STD_24H,BICARBONATE_AVG_24H,BICARBONATE_STD_24H,CREATININE_AVG_24H,CREATININE_STD_24H,PH_AVG_48H,
PH_STD_48H,PO2_AVG_48H,PO2_STD_48H,WHITEBLOOD_AVG_48H,WHITEBLOOD_STD_48H,LACTATE_AVG_48H,LACTATE_STD_48H,HEMOGLOBIN_AVG_48H,HEMOGLOBIN_STD_48H,PCO2_AVG_48H,
PCO2_STD_48H,BICARBONATE_AVG_48H,BICARBONATE_STD_48H,CREATININE_AVG_48H,CREATININE_STD_48H,PH_AVG_72H,PH_STD_72H,PO2_AVG_72H,PO2_STD_72H,WHITEBLOOD_AVG_72H,
WHITEBLOOD_STD_72H,LACTATE_AVG_72H,LACTATE_STD_72H,HEMOGLOBIN_AVG_72H,HEMOGLOBIN_STD_72H,PCO2_AVG_72H,PCO2_STD_72H,BICARBONATE_AVG_72H,BICARBONATE_STD_72H,
CREATININE_STD_72H,CREATININE_AVG_72H,GLUCOSE_VARIABILITY_ICU,TIME_HIPO_CRITICAL_SUM_24H,TIME_HIPO_MODERATE_SUM_24H,TIME_HYPER_GLUCE_SUM_24H,TIME_RANGE_PROTOCOL_SUM_24H,
TIME_RANGE_CLINIC_SUM_24H,GLUCOSE_VARIABILITY_24H,TIME_HIPO_CRITICAL_SUM_48H,TIME_HIPO_MODERATE_SUM_48H,TIME_HYPER_GLUCE_SUM_48H,TIME_RANGE_PROTOCOL_SUM_48H,
TIME_RANGE_CLINIC_SUM_48H,GLUCOSE_VARIABILITY_48H,TIME_HIPO_CRITICAL_SUM_72H,TIME_HIPO_MODERATE_SUM_72H,TIME_HYPER_GLUCE_SUM_72H,TIME_RANGE_PROTOCOL_SUM_72H,
TIME_RANGE_CLINIC_SUM_72H,
HIPO_CRITICAL_PERCENT_ICU,HIPO_MODERATE_PERCENT_ICU,HYPER_GLUCE_PERCENT_ICU,IN_RANGE_CLINIC_PERCENT_ICU,IN_RANGE_PROTOCOL_PERCENT_ICU,
HIPO_CRITICAL_PERCENT_24H,HIPO_MODERATE_PERCENT_24H,HYPER_GLUCE_PERCENT_24H,IN_RANGE_CLINIC_PERCENT_24H,IN_RANGE_PROTOCOL_PERCENT_24H,
HIPO_CRITICAL_PERCENT_48H,HIPO_MODERATE_PERCENT_48H,HYPER_GLUCE_PERCENT_48H,IN_RANGE_CLINIC_PERCENT_48H,IN_RANGE_PROTOCOL_PERCENT_48H,
HIPO_CRITICAL_PERCENT_72H,HIPO_MODERATE_PERCENT_72H,HYPER_GLUCE_PERCENT_72H,IN_RANGE_CLINIC_PERCENT_72H,IN_RANGE_PROTOCOL_PERCENT_72H,
GLUCOSE_VARIABILITY_72H,NUT_TPN_IN_24H,NUT_NPO_IN_24H,NUT_PPN_IN_24H,
NUT_TFE_IN_24H,NUT_TPN_IN_48H,NUT_NPO_IN_48H,NUT_PPN_IN_48H,NUT_TFE_IN_48H,NUT_TPN_IN_72H,NUT_NPO_IN_72H,NUT_PPN_IN_72H,NUT_TFE_IN_72H
from 
ds_icu_stays_1")
```


# 20445 of 168 variables

#first we converted the logical values to 1=TRUE / 0=FALSE
```{r}
ds_icu_2m[,sapply(ds_icu_2m,is.logical)]<-ds_icu_2m[,sapply(ds_icu_2m,is.logical)]+0

```


#PAT_GENDER to 0,1 FEMALE->1, MALE->0
```{r}
ds_icu_2m$pat_gender=ds_icu_2m$pat_gender=="F"
ds_icu_2m$pat_gender=ds_icu_2m$pat_gender+0

tbl1<-table(ds_icu_2m$pat_gender)
prop.table(tbl1)
addmargins(tbl1)
```

#PAT_EXPIRE_HOSP

```{r}
tbl1<-table(ds_icu_2m$pat_expire_hosp)
prop.table(tbl1)
addmargins(tbl1)
```

```{r}
#delete column
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% c("pat_expire_hosp"))]
```

#ADT_HOS_AGE

```{r}
ggplot(data=ds_icu_2m,aes(x=ds_icu_2m$adt_hos_age))+geom_histogram(alpha=0.4,binwidth = 10,fill="blue")+
  ggtitle("Age distribution")+
  xlab("Age")+
  theme(plot.title = element_text(hjust = 0.5))


#nulos
sum(is.na(ds_icu_2m$pat_gender))
#summary
summary(ds_icu_2m$adt_hos_age)
```


```{r}
# asign to decades

ds_icu_2m$adt_hos_age<-cut(ds_icu_2m$adt_hos_age,breaks=seq(0,100,10),labels=seq(0,9))

```

#ADT_HSTAYS
```{r}
ggplot(data=ds_icu_2m,aes(x=ds_icu_2m$adt_hstays))+geom_histogram(alpha=0.4,binwidth = 1,fill="blue")

#nulos
sum(is.na(ds_icu_2m$adt_hstays))
#summary
summary(ds_icu_2m$adt_hstays)
```

#ADT_READMIT
```{r}
#nulos
sum(is.na(ds_icu_2m$adt_readmit))
#summary
summary(ds_icu_2m$adt_readmit)

tbl1<-table(ds_icu_2m$adt_readmit)
prop.table(tbl1)
addmargins(tbl1)
```
```{r}
#delete column
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% c("adt_readmit"))]
```

#ICU_DBSOURCE
```{r}
ds_icu_2m$icu_dbsource<-as.factor(ds_icu_2m$icu_dbsource)

summary(ds_icu_2m$icu_dbsource)
```


#ICU_LOS
```{r}
ggplot(data=ds_icu_2m,aes(x=ds_icu_2m$icu_los))+geom_histogram(alpha=0.4,binwidth = 1,fill="blue")+
  ggtitle("ICU LOS")+
  xlab("days")+
  theme(plot.title = element_text(hjust = 0.5))


#nulos
sum(is.na(ds_icu_2m$icu_los))
#summary
summary(ds_icu_2m$icu_los)
```

#ICU_TYPE_FSERVICE
```{r}
ds_icu_2m$icu_type_fservice<-as.factor(ds_icu_2m$icu_type_fservice)

summary(ds_icu_2m$icu_type_fservice)


```

```{r}
#IMPUTATION + REFACTOR
ds_icu_2m$icu_type_fservice[which(ds_icu_2m$icu_type_fservice=="-")]<-"MEDICAL"
ds_icu_2m$icu_type_fservice<-droplevels(ds_icu_2m$icu_type_fservice)
summary(ds_icu_2m$icu_type_fservice)
```

#ICU_DEAD_BEFORE_28
```{r}
#nulos
sum(is.na(ds_icu_2m$icu_dead_before_28))
#summary

tbl1<-table(ds_icu_2m$icu_dead_before_28)
prop.table(tbl1)
addmargins(tbl1)
```

#ICU_HAS_PRESC_INSULIN
```{r}
#nulos
sum(is.na(ds_icu_2m$icu_has_presc_insulin))
#summary

tbl1<-table(ds_icu_2m$icu_has_presc_insulin)
prop.table(tbl1)
addmargins(tbl1)
```


#ICU_HAS_ADMIV_INSULIN
```{r}
#nulos
sum(is.na(ds_icu_2m$icu_has_admiv_insulin))
#summary

tbl1<-table(ds_icu_2m$icu_has_admiv_insulin)
prop.table(tbl1)
addmargins(tbl1)
```

#ICU_HAS_ADMIT_INSULIN
```{r}
#nulos
sum(is.na(ds_icu_2m$icu_has_admit_insulin))
#summary

tbl1<-table(ds_icu_2m$icu_has_admit_insulin)
prop.table(tbl1)
addmargins(tbl1)
```
#MED_HAS_ALLERGIE_INSULIN

```{r}
nearZeroVar(ds_icu_2m$med_has_allergie_insulin)
```
```{r}
#delete column
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% c("med_has_allergie_insulin"))]
```



#ICD9P_M
```{r}

#FACTOR
ds_icu_2m$icd9p_m<-as.factor(as.character(ds_icu_2m$icd9p_m))
#summary

```
```{r}
#delete column
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% c("icd9p_m"))]
```

#ICD9D_M
```{r}

#FACTOR
ds_icu_2m$icd9d_m<-as.factor(as.character(ds_icu_2m$icd9d_m))
#summary
```


#DIAG_M_HAS_DIABET / DIAG_S_HAS_DIABET
```{r}

#combine columns OR

ds_icu_2m$diag_has_diabet<-(ds_icu_2m$diag_m_has_diabet | ds_icu_2m$diag_s_has_diabet) 
ds_icu_2m$diag_has_diabet<-ds_icu_2m$diag_has_diabet+0
```

```{r}
#delete column
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% c("diag_s_has_diabet","diag_m_has_diabet"))]
```

```{r}
tbl1<-table(ds_icu_2m$diag_has_diabet)
prop.table(tbl1)
addmargins(tbl1)
```
#COM_
```{r}

#nulos

df_com<-ds_icu_2m %>% dplyr::select(starts_with("COM_"))

sum(is.na(df_com))

```

#near zero var
```{r}
nzv<-nearZeroVar(df_com)

(czv<-names(df_com[nzv]))

ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% czv)]
```

```{r}
rm(df_com)
```

#SCORES

#SCORE_APSIII
```{r}
ggplot(data=ds_icu_2m,aes(x=ds_icu_2m$score_apsiii))+geom_density(alpha=0.4,fill="blue")

#nulos
sum(is.na(ds_icu_2m$score_apsiii))
#summary
summary(ds_icu_2m$score_apsiii)
```

```{r}
g1<-glm(ds_icu_2m$icu_dead_before_28~ds_icu_2m$score_apsiii,family = binomial)
(r1<-roc(ds_icu_2m$icu_dead_before_28,predict(g1,type = "response")))
plot(r1)
```

```{r}
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% c("score_apsiii"))]
```


#SCORE_LODS
```{r}
ggplot(data=ds_icu_2m,aes(x=ds_icu_2m$score_lods))+geom_histogram(alpha=0.4,binwidth = 1,fill="blue")

#nulos
sum(is.na(ds_icu_2m$score_lods))
#summary
summary(ds_icu_2m$score_lods)
```

```{r}
g1<-glm(ds_icu_2m$icu_dead_before_28~ds_icu_2m$score_lods,family = binomial)
(r1<-roc(ds_icu_2m$icu_dead_before_28,predict(g1,type = "response")))
plot(r1)
```


```{r}
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% c("score_lods"))]
```


#SCORE_MLODS
```{r}
ggplot(data=ds_icu_2m,aes(x=ds_icu_2m$score_mlods))+geom_histogram(alpha=0.4,binwidth = 1,fill="blue")

#nulos
sum(is.na(ds_icu_2m$score_mlods))
#summary
summary(ds_icu_2m$score_mlods)
```

```{r}
g1<-glm(ds_icu_2m$icu_dead_before_28~ds_icu_2m$score_mlods,family = binomial)
(r1<-roc(ds_icu_2m$icu_dead_before_28,predict(g1,type = "response")))
plot(r1)
```

```{r}
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% c("score_mlods"))]
```


#SCORE_OASIS
```{r}
ggplot(data=ds_icu_2m,aes(x=ds_icu_2m$score_oasis))+geom_density(alpha=0.4,fill="blue")

#nulos
sum(is.na(ds_icu_2m$score_oasis))
#summary
summary(ds_icu_2m$score_oasis)
```

```{r}
g1<-glm(ds_icu_2m$icu_dead_before_28~ds_icu_2m$score_oasis,family = binomial)
(r1<-roc(ds_icu_2m$icu_dead_before_28,predict(g1,type = "response")))
plot(r1)
```

```{r}
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% c("score_oasis"))]
```


#SCORE_QSOFA
```{r}
ggplot(data=ds_icu_2m,aes(x=ds_icu_2m$score_qsofa))+geom_histogram(binwidth = 1,alpha=0.4,fill="blue")

#nulos
sum(is.na(ds_icu_2m$score_qsofa))
#summary
summary(ds_icu_2m$score_qsofa)
```


```{r}
g1<-glm(ds_icu_2m$icu_dead_before_28~ds_icu_2m$score_qsofa,family = binomial)
(r1<-roc(ds_icu_2m$icu_dead_before_28,predict(g1,type = "response")))
plot(r1)
```

```{r}
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% c("score_qsofa"))]
```


#SCORE_SAPS
```{r}
ggplot(data=ds_icu_2m,aes(x=ds_icu_2m$score_saps))+geom_histogram(binwidth = 1,alpha=0.4,fill="blue")

#nulos
sum(is.na(ds_icu_2m$score_saps))
#summary
summary(ds_icu_2m$score_saps)
```
```{r}
g1<-glm(ds_icu_2m$icu_dead_before_28~ds_icu_2m$score_saps,family = binomial)
(r1<-roc(ds_icu_2m$icu_dead_before_28,predict(g1,type = "response")))
plot(r1)
```

```{r}
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% c("score_saps"))]
```



#SCORE_SAPSII
```{r}
ggplot(data=ds_icu_2m,aes(x=ds_icu_2m$score_sapsii))+geom_density(alpha=0.4,fill="blue")+
  ggtitle("SAPSII distribution")+
  xlab("Value")+
  theme(plot.title = element_text(hjust = 0.5))

#nulos
sum(is.na(ds_icu_2m$score_sapsii))
#summary
summary(ds_icu_2m$score_sapsii)
```
```{r}
g1<-glm(ds_icu_2m$icu_dead_before_28~ds_icu_2m$score_sapsii,family = binomial)
(r1<-roc(ds_icu_2m$icu_dead_before_28,predict(g1,type = "response")))
plot(r1)
```


#SCORE_SOFA
```{r}
ggplot(data=ds_icu_2m,aes(x=ds_icu_2m$score_sofa))+geom_histogram(binwidth=1,alpha=0.4,fill="blue")+
  ggtitle("SOFA distribution")+
  xlab("Value")+
  theme(plot.title = element_text(hjust = 0.5))

  

#nulos
sum(is.na(ds_icu_2m$score_sofa))
#summary
summary(ds_icu_2m$score_sofa)
```


```{r}
g1<-glm(ds_icu_2m$icu_dead_before_28~ds_icu_2m$score_sofa,family = binomial)
(r1<-roc(ds_icu_2m$icu_dead_before_28,predict(g1,type = "response")))
plot(r1)
```



#SCORE_SIRS
```{r}
ggplot(data=ds_icu_2m,aes(x=ds_icu_2m$score_sirs))+geom_histogram(binwidth=1,alpha=0.4,fill="blue")

#nulos
sum(is.na(ds_icu_2m$score_sirs))
#summary
summary(ds_icu_2m$score_sirs)
```


```{r}
g1<-glm(ds_icu_2m$icu_dead_before_28~ds_icu_2m$score_sirs,family = binomial)
(r1<-roc(ds_icu_2m$icu_dead_before_28,predict(g1,type = "response")))
plot(r1)
```

```{r}
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% c("score_sirs"))]
```



#MED_
```{r}

#nulos

df_com<-ds_icu_2m %>% dplyr::select(starts_with("MED_"))

sum(is.na(df_com))

#near zero var
nzv<-nearZeroVar(df_com)
```

```{r}
colSums(df_com[nzv])
```


#AVG

```{r}
avgl<-names(ds_icu_2m[grep("_avg_24",names(ds_icu_2m))])
colSums(is.na(ds_icu_2m[avgl]))/204.45
```

```{r}
avgl<-names(ds_icu_2m[grep("_avg_48",names(ds_icu_2m))])
colSums(is.na(ds_icu_2m[avgl]))/204.45
```

```{r}
avgl<-names(ds_icu_2m[grep("_avg_72",names(ds_icu_2m))])
colSums(is.na(ds_icu_2m[avgl]))/204.45
```


```{r}
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% c("ph_avg_48h","po2_avg_48h","lactate_avg_48h","pco2_avg_48h","ph_avg_72h",
"po2_avg_72h","lactate_avg_72h","pco2_avg_72h","ph_std_48h","po2_std_48h","lactate_std_48h","pco2_std_48h","ph_std_72h",
"po2_std_72h","lactate_std_72h","pco2_std_72h"))]
```


```{r}
avgl<-names(ds_icu_2m[grep("_avg_",names(ds_icu_2m))])
par(mar=c(10,1,1,1))
boxplot(ds_icu_2m[avgl],las=2,cex.axis=1,cex=.4,cex.main=1,main="Clinic Variables (AVG)", col="grey", outcol="red",pch=20)
```


```{r}
#OUTLIERS WHITEBLOOD
ds_icu_2m$whiteblood_avg_24h[ds_icu_2m$whiteblood_avg_24h>200]<-NA
ds_icu_2m$whiteblood_avg_48h[ds_icu_2m$whiteblood_avg_48h>200]<-NA
ds_icu_2m$whiteblood_avg_48h[ds_icu_2m$whiteblood_avg_48h>200]<-NA
```

#STD

```{r}
stdl<-names(ds_icu_2m[grep("_std_",names(ds_icu_2m))])
boxplot(ds_icu_2m[stdl])
```

#DELETE STD
```{r}
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% stdl)]
```


#GLUCOSE_VARIABILITY_ICU
```{r}
ggplot(data=ds_icu_2m,aes(x=ds_icu_2m$glucose_variability_icu))+geom_density(alpha=0.4,fill="blue")
```
```{r}
summary(ds_icu_2m$glucose_variability_icu)
sum(is.na(ds_icu_2m$glucose_variability_icu))
ds_icu_2m$glucose_variability_icu[ds_icu_2m$glucose_variability_icu>500]
```


#GLUCOSE_VARIABILITY_24H
```{r}
ggplot(data=ds_icu_2m,aes(x=ds_icu_2m$glucose_variability_24h))+geom_density(alpha=0.4,fill="blue")+
  ggtitle("Glucose Variability 24H distribution")+
  xlab("Value")+
  theme(plot.title = element_text(hjust = 0.5))
```

```{r}
summary(ds_icu_2m$glucose_variability_24h)
sum(is.na(ds_icu_2m$glucose_variability_24h))

ds_icu_2m$glucose_variability_icu[ds_icu_2m$glucose_variability_24h>300]
```

#GLUCOSE_VARIABILITY_48H
```{r}
ggplot(data=ds_icu_2m,aes(x=ds_icu_2m$glucose_variability_48h))+geom_density(alpha=0.4,fill="blue")+
  ggtitle("Glucose Variability 48H distribution")+
  xlab("Value")+
  theme(plot.title = element_text(hjust = 0.5))
```

```{r}
summary(ds_icu_2m$glucose_variability_48h)
sum(is.na(ds_icu_2m$glucose_variability_48h))

ds_icu_2m$glucose_variability_icu[ds_icu_2m$glucose_variability_48h>300]
```

#GLUCOSE_VARIABILITY_72H
```{r}
ggplot(data=ds_icu_2m,aes(x=ds_icu_2m$glucose_variability_72h))+geom_density(alpha=0.4,fill="blue")
```

```{r}
summary(ds_icu_2m$glucose_variability_72h)
sum(is.na(ds_icu_2m$glucose_variability_72h))

ds_icu_2m$glucose_variability_icu[ds_icu_2m$glucose_variability_72h>300]
```

#TIME_HIPOCRITICAL_SUM

```{r}

timel<-names(ds_icu_2m[grep("time_hipo",names(ds_icu_2m))])

boxplot(ds_icu_2m[timel])

summary(ds_icu_2m[timel])


```

#TIME_HYPER

```{r}

timel<-names(ds_icu_2m[grep("time_hyper",names(ds_icu_2m))])

boxplot(ds_icu_2m[timel])

summary(ds_icu_2m[timel])


```


#TIME_RANGE

```{r}

timel<-names(ds_icu_2m[grep("time_range",names(ds_icu_2m))])

boxplot(ds_icu_2m[timel])

summary(ds_icu_2m[timel])


```

#DELETE TIME_

```{r}
#finally didnt include any TIME_

timel<-names(ds_icu_2m[grep("time_",names(ds_icu_2m))])

ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% timel)]
```


#NUT_NPO
#DELETE

```{r}
npol<-names(ds_icu_2m[grep("nut_npo",names(ds_icu_2m))])

ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% npol)]
```



#NUT_TPN

```{r}

tpnl<-names(ds_icu_2m[grep("nut_tpn",names(ds_icu_2m))])

summary(ds_icu_2m[tpnl])

```
```{r}
ds_icu_2m[tpnl][is.na(ds_icu_2m[tpnl])]<-0
summary(ds_icu_2m[tpnl])
nearZeroVar(ds_icu_2m[tpnl])

colSums(ds_icu_2m[tpnl])

```
#DELETE TPN
```{r}
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% tpnl)]
```

#NUT_PPN

```{r}

ppnl<-names(ds_icu_2m[grep("nut_ppn",names(ds_icu_2m))])

summary(ds_icu_2m[ppnl])

nearZeroVar(ds_icu_2m[ppnl])

colSums(ds_icu_2m[ppnl],na.rm = TRUE)
```

#DELETE PPN
```{r}
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% ppnl)]
```

#NUT_TFE


```{r}

tfel<-names(ds_icu_2m[grep("nut_tfe",names(ds_icu_2m))])

summary(ds_icu_2m[tfel])

nearZeroVar(ds_icu_2m[tfel])

colSums(ds_icu_2m[tfel],na.rm = TRUE)
```


```{r}
#IMPUTATION

ds_icu_2m[tfel][is.na(ds_icu_2m[tfel])]<-0
summary(ds_icu_2m[tfel])

```


#HIPO_CRITICAL

```{r}
hipol<-names(ds_icu_2m[grep("hipo_",names(ds_icu_2m))])

boxplot(ds_icu_2m[hipol])

summary(ds_icu_2m[hipol])

nearZeroVar(ds_icu_2m[hipol])

```

#DELETE HIPO
```{r}
#ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% hipol)]
```


```{r}
par(mar=c(14,2.3,2.3,2))
boxplot(ds_icu_2m[hipol],las=2,cex.axis=1,cex=.4,cex.main=1,main="Hipoglucemia - %", col="grey", outcol="red",pch=20)

```


#HYPER

```{r}
hypel<-names(ds_icu_2m[grep("hyper_",names(ds_icu_2m))])

boxplot(ds_icu_2m[hypel])

summary(ds_icu_2m[hypel])

nearZeroVar(ds_icu_2m[hypel])

```

#remove outliers
```{r}
ds_icu_2m$hyper_gluce_percent_72h[ds_icu_2m$hyper_gluce_percent_72h<0]<-NA
ds_icu_2m$hyper_gluce_percent_72h[ds_icu_2m$hyper_gluce_percent_72h>100]<-NA
```

```{r}
par(mar=c(14,2.3,2.3,2))
boxplot(ds_icu_2m[hypel],las=2,cex.axis=1,cex=.4,cex.main=1,main="Hyperglucemia - %", col="grey", outcol="red",pch=20)
```


#IN_RANGE

```{r}
inrl<-names(ds_icu_2m[grep("in_range_",names(ds_icu_2m))])

boxplot(ds_icu_2m[inrl])

summary(ds_icu_2m[inrl])

nearZeroVar(ds_icu_2m[inrl])

```
#remove outliers
```{r}
ds_icu_2m$in_range_clinic_percent_72h[ds_icu_2m$in_range_clinic_percent_72h<0]<-NA
ds_icu_2m$in_range_clinic_percent_72h[ds_icu_2m$in_range_clinic_percent_72h>100]<-NA
ds_icu_2m$in_range_protocol_percent_72h[ds_icu_2m$in_range_protocol_percent_72h<0]<-NA
ds_icu_2m$in_range_protocol_percent_72h[ds_icu_2m$in_range_protocol_percent_72h>100]<-NA
```


```{r}
par(mar=c(14,2.3,2.3,2))
boxplot(ds_icu_2m[inrl],las=2,cex.axis=1,cex=.4,cex.main=1,main="Glucose - In range %", col="grey", outcol="red",pch=20)
```




#FINAL FORMAT DATASET
```{r}
#only variables obtained for <72H
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% names(ds_icu_2m[grep("_icu",names(ds_icu_2m))]))]

#delete icu_los and adt_hstays
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% c("icu_los","adt_hstays"))]

#db_sources
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% c("icu_dbsource"))]

#problems with factor
ds_icu_2m$adt_hos_age<-as.numeric(ds_icu_2m$adt_hos_age)

```

```{r}
#delete only score_sapii data
ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% c("score_sapsii"))]
```

```{r}
#auxiliar variable
ds_icu_2m$score_sofa_more4<-as.numeric(ds_icu_2m$score_sofa>=4)
```


```{r}
#group icd9_m_chapter
dicd9<-(ds_icu_2m %>% group_by(icd9d_m_chapter) %>% summarise(n=n()) %>% arrange(n))

#refactoring as others
dicd_others<-filter(dicd9,n<1000)
ds_icu_2m$icd9d_m_chapter<-as.character(ds_icu_2m$icd9d_m_chapter)
ds_icu_2m<-ds_icu_2m %>% mutate(icd9d_m_chapter=ifelse(icd9d_m_chapter %in% dicd_others$icd9d_m_chapter,"00-Others",icd9d_m_chapter))
ds_icu_2m$icd9d_m_chapter<-as.factor(ds_icu_2m$icd9d_m_chapter)

ds_icu_2m<-ds_icu_2m[,-which(names(ds_icu_2m) %in% c("icd9d_m"))]
```

```{r}
#imputation and normalize with caret
preproc_ds_range<-preProcess(ds_icu_2m,method = c("medianImpute","range"))
ds_icu_2m<-predict(preproc_ds_range,ds_icu_2m)
```

```{r}
#factorize outcome
ds_icu_2m$icu_dead_before_28<-as.factor(ds_icu_2m$icu_dead_before_28)
levels(ds_icu_2m$icu_dead_before_28)<-make.names(levels(ds_icu_2m$icu_dead_before_28))
```

```{r}
str(ds_icu_2m)
names(ds_icu_2m)

```


```{r}
save(file="~/Master_ICM/TFM/r_Projects/2_fase/ds_icu_2m",ds_icu_2m)
```



